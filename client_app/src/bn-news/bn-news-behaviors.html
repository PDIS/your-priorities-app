<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/jquery/dist/jquery.min.js"></script>

<script>
  /**
   * @polymerBehavior Polymer.GroupBehaviors
   */
  Polymer.GroupBehaviors = {

    properties: {
      group: {
        type: Object,
        notify: true,
        observer: '_groupChanged'
      },

      elevation: {
        type: Number
      },

      groupLogoImagePath: {
        type: String,
        computed: '_groupLogoImagePath(group)'
      },

      groupHeaderImagePath: {
        type: String,
        computed: '_groupHeaderImagePath(group)'
      },

      groupName: {
        type: String,
        computed: '_groupName(group)'
      },

      groupTags: {
        type: String,
        computed: '_groupTags(group)'
      },

      groupObjectives: {
        type: String,
        computed: '_groupObjectives(group)'
      },

      trustRate: {
        type: Number,
        computed: '_trustRate(group)'
      },

      noImage: {
        type: Boolean,
        value: true
      },

      featured: {
        type: Boolean,
        value: false
      },

      archived: {
        type: Boolean,
        value: false
      },

      wide: {
        type: Boolean
      }
    },

    _groupChanged: function (group) {
      if (group) {
        if (group.GroupLogoImages && group.GroupLogoImages.length > 0) {
          this.set('noImage', false);
        } else {
          this.set('noImage', true);
        }

        if (group.status == 'featured') {
          this.set('featured', true);
        } else if (group.status == 'archived') {
          this.set('archived', true);
        } else {
          this.set('featured', false);
          this.set('archived', false);
        }

        this.async(function () {
          var groupName = this.$$("#groupName");
          if (groupName) {
            if (this.wide) {
              if (group.name.length <= 18) {
                groupName.style.fontSize = "30px";
              } else if (group.name.length > 40) {
                groupName.style.fontSize = "22px";
              } else if (group.name.length > 30) {
                groupName.style.fontSize = "24px";
              } else if (group.name.length > 18) {
                groupName.style.fontSize = "26px";
              }
            } else {
              if (group.name.length <= 18) {
                groupName.style.fontSize = "28px";
              } else if (group.name.length > 40) {
                groupName.style.fontSize = "19px";
              } else if (group.name.length > 30) {
                groupName.style.fontSize = "22px";
              } else if (group.name.length > 18) {
                groupName.style.fontSize = "24px";
              }
            }

            if (this.archived) {
              var fontSizePixels = groupName.style.fontSize.replace("px", "");
              fontSizePixels = parseInt(fontSizePixels);
              fontSizePixels = fontSizePixels - 3;
              groupName.style.fontSize = fontSizePixels + "px";
            }
          }

          var authorName = this.$$('#author_name');
          var authorImage = this.$$('#author_image');
          if (authorImage != null && authorName != null) {
            $.ajax('/api/users/' + group.user_id,
              {
                success: function(user) {
                  authorName.innerHTML = user.name;
                  if (user.UserProfileImages.length > 0) {
                    authorImage.src = JSON.parse(user.UserProfileImages[0].formats)[0];
                  }
                },
                error: function(xhr, errTxt, error) {
                  console.log('Error while getting user: ' + errTxt);
                  console.log(error);
                }
              });
          }

          var rate = Math.floor(Math.random() * 100) + "%";
          this.$$('.trustBar').style.width = rate;
          this.$$('.indicator').style.left = 'calc(' + rate + '-24px)';
          this.$$('.trustRate').innerHTML = rate;
        });
      } else {
        this.set('featured', false);
        this.set('archived', false);
      }
    },

    _goToGroup: function (e) {
      var groupUrl = '/group/' + this.group.id;
      window.appGlobals.activity('open', 'group', groupUrl);
      this.redirectTo(groupUrl);
    },

    _groupLogoImagePath: function (group) {
      if (group) {
        return this.getImageFormatUrl(group.GroupLogoImages, 0);
      } else {
        return "";
      }
    },

    _groupHeaderImagePath: function (group) {
      if (group) {
        return this.getImageFormatUrl(group.GroupHeaderImages, 0);
      } else {
        return "";
      }
    },

    _groupName: function (group) {
      if (group) {
        if (group.name) {
          return this.truncate(this.trim(group.name), 60);
        } else {
          return group.short_name;
        }
      } else {
        return "";
      }
    },

    _groupTags: function (group) {
      if (group) {
        if (group.tags) {
          // return this.truncate(this.trim(group.name), 60);
          var ret = '';
          for (var i in group.tags) {
            if (i > 0) {
              ret += 'ãƒ»';
            }
            ret += group.tags[i];
          }
          return this.truncate(ret);
        } else {
          return "";
        }
      } else {
        return "";
      }
    },

    _trustRate: function (group) {
      return 40;
    },

    _groupCreator: function (group) {
      if (group) {

      } else {
        return "Unknown user";
      }
    },

    _groupObjectives: function (group) {
      if (group && group.objectives) {
        return this.truncate(this.trim(group.objectives), 200, '...');
      } else {
        return "";
      }
    }
  };
</script>
