<link rel="import" href="../../bower_components/polymer/polymer.html?v=8.0.0-4"><link rel="import" href="../../bower_components/iron-form/iron-form.html?v=8.0.0-4"><link rel="import" href="../../bower_components/lite-signal/lite-signal.html?v=8.0.0-4"><link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html?v=8.0.0-4"><link rel="import" href="../../bower_components/paper-input/paper-input.html?v=8.0.0-4"><link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html?v=8.0.0-4"><link rel="import" href="../../bower_components/paper-button/paper-button.html?v=8.0.0-4"><link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html?v=8.0.0-4"><link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html?v=8.0.0-4"><link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html?v=8.0.0-4"><link rel="import" href="../yp-behaviors/yp-language-behavior.html?v=8.0.0-4"><link rel="import" href="../yp-behaviors/yp-goto-behavior.html?v=8.0.0-4"><dom-module id="yp-login"><template><style include="iron-flex iron-flex-alignment">.btn-auth,.btn-auth:visited{position:relative;display:inline-block;height:22px;padding:0 1em;border:1px solid #999;border-radius:2px;text-align:center;text-decoration:none;font-size:14px;line-height:22px;white-space:nowrap;cursor:pointer;color:#222;background:#fff;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-appearance:none;margin:4px}.btn-auth:active,.btn-auth:focus,.btn-auth:hover{color:#222;text-decoration:none}.btn-auth:before{content:"";float:left;width:22px;height:22px;background:url(/images/auth-icons.png) no-repeat 99px 99px}.btn-auth.large{height:32px;line-height:36px;font-size:20px}.btn-auth.large:before{width:36px;height:36px}.btn-auth::-moz-focus-inner{border:0;padding:0}.btn-facebook,.btn-facebook:visited{border-color:#29447e;border-bottom-color:#1a356e;color:#fff;background-color:#5872a7;background-image:-webkit-gradient(linear,0 0,0 100%,from(#637bad),to(#5872a7));background-image:-webkit-linear-gradient(#637bad,#5872a7);background-image:-moz-linear-gradient(#637bad,#5872a7);background-image:-ms-linear-gradient(#637bad,#5872a7);background-image:-o-linear-gradient(#637bad,#5872a7);background-image:linear-gradient(#637bad,#5872a7);-webkit-box-shadow:inset 0 1px 0 #879ac0;box-shadow:inset 0 1px 0 #879ac0}.btn-facebook:focus,.btn-facebook:hover{color:#fff;background-color:#3b5998}.btn-facebook:active{color:#fff;background:#4f6aa3;-webkit-box-shadow:inset 0 1px 0 #45619d;box-shadow:inset 0 1px 0 #45619d}.btn-facebook:before{border-right:1px solid #465f94;margin:0 1em 0 -1em;background-position:0 0}.btn-facebook.large:before{background-position:0 -22px}paper-dialog{padding-left:8px;padding-right:8px;width:450px;background-color:#fff}.innerScroll{height:100%!important}.islandIs{width:80px;height:18px;padding-left:16px;padding-top:8px;padding-bottom:8px;padding-right:8px;margin-left:8px}paper-spinner{padding:0;margin:0}.buttons{color:var(--accent-color,#000);font-size:15px;margin-top:20px;text-align:center;vertical-align:bottom;margin-bottom:3px}.boldButton{font-weight:700}@media (max-width:480px){paper-dialog{padding:0;margin:0;width:100%}}@media (max-width:480px){.buttons{margin-top:12px;font-size:14px}}@media (max-width:320px){paper-dialog{min-width:320px}:host{max-height:100%!important;height:100%!important}.buttons{font-size:13px}}.additionAuthMethodsDivider{color:#444;padding-bottom:8px}.strike{display:block;text-align:center;overflow:hidden;white-space:nowrap;font-size:17px}.strike>span{position:relative;display:inline-block}.strike>span:after,.strike>span:before{content:"";position:absolute;top:50%;width:9999px;height:1px;background:#888}.strike>span:before{right:85%;margin-right:15px}.strike>span:after{left:85%;margin-left:15px}.socialMediaLogin{padding-top:8px;margin-top:8px;padding-bottom:16px}.cursor{cursor:pointer}.orContainer{padding-top:0;margin-top:0;padding-bottom:4px;color:#555}.customUserRegistrationText{font-size:14px;margin:8px;margin-bottom:8px}.mainSpinner[hide]{display:none}[hidden]{display:none!important}.openTerms{text-decoration:underline;cursor:pointer}@media all and (-ms-high-contrast:none){#scrollable{min-height:350px}}.signupTerms{margin-top:16px;margin-bottom:8px}.ajaxElements{margin-top:8px}.forceSecureSamlLoginInfo{font-weight:700;font-size:17px;margin-bottom:8px}.anonLoginButton{margin-top:0;margin-bottom:12px}paper-tabs{margin-bottom:8px}.largeSamlLogo{margin-top:16px;border:1px solid;border-color:#ddd;padding:12px}</style><lite-signal on-lite-signal-yp-language="_languageEvent"></lite-signal><lite-signal on-lite-signal-yp-domain-changed="_domainEvent"></lite-signal><paper-dialog id="dialog" modal=""><paper-dialog-scrollable id="scrollable"><iron-form id="form"><form name="loginForm"><paper-tabs selected="{{registerMode}}" id="paper_tabs" focused="" hidden$="[[forceSecureSamlLogin]]"><paper-tab>[[t('user.login')]]</paper-tab><paper-tab>[[t('user.register')]]</paper-tab></paper-tabs><div class="forceSecureSamlLoginInfo" hidden$="[[!forceSecureSamlLogin]]">[[t('forceSecureSamlLoginInfo')]]</div><div class="layout vertical innerScroll"><span hidden$="[[!registerMode]]"><div hidden$="[[!customUserRegistrationText]]" class="customUserRegistrationText">[[customUserRegistrationText]]</div></span><div class="layout vertical center-center socialMediaLogin" hidden$="[[!hasAdditionalAuthMethods]]"><div class="layout vertical center-center"><template is="dom-if" if="[[hasAnonymousLogin]]"><paper-button raised="" class="anonLoginButton" on-tap="anonymousLogin">[[t('participateAnonymously')]]</paper-button></template><div class="layout horizontal"><template is="dom-if" if="[[hasFacebookLogin]]"><span hidden$="[[forceSecureSamlLogin]]"><div class="btn-auth btn-facebook cursor" on-tap="_facebookLogin" hidden$="[[disableFacebookLoginForGroup]]">[[t('user.facebookLogin')]]</div></span></template><template is="dom-if" if="[[hasSamlLogin]]"><div class="islandIs cursor layout horizontal center-center"><img hidden$="[[forceSecureSamlLogin]]" on-tap="_islandIsLogin" width="80" height="18" src="https://s3.amazonaws.com/yrpri-direct-asset/yrpri6/islandisLogo.png"><div hidden$="[[!forceSecureSamlLogin]]" class="largeSamlLogo" on-tap="_islandIsLogin"><img width="130" height="30" src="https://s3.amazonaws.com/yrpri-direct-asset/yrpri6/islandisLogo.png"></div></div></template></div></div></div><div class="orContainer" hidden$="[[!hasAdditionalAuthMethods]]"><div class="strike" hidden$="[[forceSecureSamlLogin]]"><span>[[t('or')]]</span></div></div><div hidden$="[[forceSecureSamlLogin]]"><template is="dom-if" if="[[registerMode]]" restamp=""><paper-input id="name" type="text" label="[[t('user.name')]]" value="{{name}}" maxlength="50" minlength="2" required="" char-counter=""></paper-input></template><paper-input id="email" type="text" label="[[t('user.email')]]" value="{{email}}" pattern="[[emailValidationPattern]]" error-message="[[emailErrorMessage]]"></paper-input><paper-input id="password" type="password" label="[[t('user.password')]]" value="{{password}}" error-message="[[passwordErrorMessage]]"></paper-input></div></div><div class="signupTerms" hidden$="[[!showSignupTerms]]">{{t('signupTermsInfo')}} - <span on-tap="_openTerms" class="openTerms">{{t('signupTermsOpen')}}</span></div><div class="buttons layout vertical center-center"><div class="layout horizontal center-center"><paper-button dialog-dismiss="" on-tap="_cancel">[[t('cancel')]]</paper-button><paper-button hidden$="[[forceSecureSamlLogin]]" on-tap="_forgotPassword">[[t('user.newPassword')]]</paper-button><paper-button hidden$="[[forceSecureSamlLogin]]" autofocus="" raised="" class="boldButton" on-tap="_validateAndSend">[[submitText]]</paper-button></div></div></form></iron-form></paper-dialog-scrollable><div class="layout horizontal center-center ajaxElements"><paper-spinner active="" class="mainSpinner" hide$="[[!userSpinner]]"></paper-spinner><yp-ajax id="loginAjax" dispatch-error="" on-error="_loginError" method="POST" url="/api/users/login" on-response="_loginResponse"></yp-ajax><yp-ajax id="registerAjax" method="POST" dispatch-error="" on-error="_registerError" url="/api/users/register" on-response="_registerResponse"></yp-ajax><yp-ajax id="pagesAjax" on-response="_pagesResponse"></yp-ajax></div></paper-dialog><iron-a11y-keys id="a11y" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys><yp-ajax id="registerAnonymouslyAjax" method="POST" dispatch-error="" on-error="_registerError" url="/api/users/register_anonymously" on-response="_registerResponse"></yp-ajax></template></dom-module><script>Polymer({is:"yp-login",behaviors:[Polymer.ypLanguageBehavior,Polymer.ypGotoBehavior],properties:{userSpinner:{type:Boolean,value:!1},domain:{type:Object},reCaptchaSiteKey:{type:String,value:"6Ld9UBsTAAAAAPq059P_AGqo-tVE_T9gPj5ifrmY"},emailValidationPattern:{type:String,value:"^[_A-Za-z0-9-\\+]+(\\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\\.[A-Za-z0-9]+)*(\\.[A-Za-z]{2,})$"},emailErrorMessage:{type:String},passwordErrorMessage:{type:String},name:{type:String,value:""},email:{type:String,value:""},password:{type:String,value:""},credentials:{type:String,notify:!0,computed:"_computeCredentials(name, email, password)"},registerMode:{type:Number,value:0,observer:"_onRegisterChanged"},submitText:{type:String,value:""},redirectToURL:{type:String,value:null},forgotPasswordOpen:{type:Boolean,value:!1},heading:{type:String},customUserRegistrationText:{type:String,value:null},opened:{type:Boolean,value:!1,observer:"_openedChanged"},target:{type:Object},onLoginFunction:{type:Function,value:null},hasFacebookLogin:{type:Boolean,value:null,computed:"_hasFacebookLogin(domain)"},hasAnonymousLogin:{type:Boolean,value:!1},hasSamlLogin:{type:Boolean,value:null,computed:"_hasSamlLogin(domain)"},hasAdditionalAuthMethods:{type:Boolean,computed:"_hasAdditionalAuthMethods(domain, hasAnonymousLogin, disableFacebookLoginForGroup)"},disableFacebookLoginForGroup:{type:Boolean,value:!1},pollingStartedAt:{type:Date,value:null},signupTermsId:{type:Number,value:null},showSignupTerms:{type:Boolean,computed:"_showSignupTerms(signupTermsId, registerMode)"},forceSecureSamlLogin:{type:Boolean,value:!1}},_showSignupTerms:function(i,o){return i&&1==o},_isiOsInApp:function(){return/iPad|iPhone|Android|iPod/.test(navigator.userAgent)&&!window.MSStream&&/FBAN/.test(navigator.userAgent)},_openTerms:function(){this.fire("yp-open-page",{pageId:this.signupTermsId})},_facebookLogin:function(){var i=window.location.hostname.split(".").slice(-2).join("."),o="https://"+(i.indexOf("forbrukerradet")>-1?"mineideer":"login")+"."+i+"/api/users/auth/facebook",e=(window.outerHeight-650)/2,n=(window.outerWidth-1e3)/2;this._isiOsInApp()?window.location=o:window.appUser.facebookPopupWindow=window.open(o,"_blank","width=1000,height=650,scrollbars=0,top="+e+",left="+n),window.appUser.startPollingForLogin(),this._startSpinner(),window.appGlobals.sendLoginAndSignupToAnalytics(null,"Login Submit","Facebook")},anonymousLogin:function(){this.$$("#registerAnonymouslyAjax").body={groupId:window.appGlobals.currentAnonymousGroup.id,trackingParameters:window.appGlobals.originalQueryParameters},this.$$("#registerAnonymouslyAjax").generateRequest(),window.appGlobals.sendLoginAndSignupToAnalytics(null,"Signup Submit","Anonymous")},_islandIsLogin:function(){this.forceSecureSamlLogin&&window.appUser&&window.appUser.user&&(window.appUser.logout(),this.async(function(){window.appUser.logout()}));var i="/api/users/auth/saml",o=(window.outerHeight-650)/2,e=(window.outerWidth-1200)/2;this._isiOsInApp()?window.location=i:window.appUser.samlPopupWindow=window.open(i,"_blank","width=1200,height=650,scrollbars=0,top="+o+",left="+e),window.appUser.startPollingForLogin(),this._startSpinner(),window.appGlobals.sendLoginAndSignupToAnalytics(null,"Login Submit","Saml2")},_startSpinner:function(){this.set("userSpinner",!0),this.async(function(){this.$.dialog.fire("iron-resize")})},_cancel:function(){this.set("userSpinner",!0),window.appUser.cancelLoginPolling()},_domainEvent:function(i,o){o.domain&&this.set("domain",o.domain)},_hasAdditionalAuthMethods:function(i,o){return i&&(this._hasFacebookLogin(i)&&!this.disableFacebookLoginForGroup||this._hasSamlLogin(i)||o)},_hasFacebookLogin:function(i){return!!i&&(null!=i.facebookLoginProvided&&""!=i.facebookLoginProvided)},_hasSamlLogin:function(i){return!!i&&(null!=i.samlLoginProvided&&""!=i.samlLoginProvided)},_openedChanged:function(i){i&&(window.appGlobals.currentAnonymousGroup?this.set("hasAnonymousLogin",!0):this.set("hasAnonymousLogin",!1),window.appGlobals.disableFacebookLoginForGroup?this.set("disableFacebookLoginForGroup",!0):this.set("disableFacebookLoginForGroup",!1),window.appGlobals.domain&&window.appGlobals.domain.configuration&&window.appGlobals.domain.configuration.customUserRegistrationText?this.set("customUserRegistrationText",window.appGlobals.domain.configuration.customUserRegistrationText):this.set("customUserRegistrationText",null),this.async(function(){this.$$("#a11y").target=this.$$("#form"),this.$$("#email").focus()}.bind(this),50),window.appGlobals.signupTermsPageId?this.signupTermsId=window.appGlobals.signupTermsPageId:this.signupTermsId=null,window.appGlobals.currentGroupForceSaml?this.set("forceSecureSamlLogin",!0):this.set("forceSecureSamlLogin",!1))},onEnter:function(i){this._validateAndSend()},_registerError:function(i,o){"SequelizeUniqueConstraintError"==o?this.$$("#registerAjax").showErrorDialog(this.t("user.alreadyRegisterred")):this.$$("#registerAjax").showErrorDialog(this.t("user.registrationError")+": "+o),window.appGlobals.sendLoginAndSignupToAnalytics(null,"Signup Fail","Email",o)},_loginError:function(i,o){"Unauthorized"==o?this.$$("#loginAjax").showErrorDialog(this.t("user.loginNotAuthorized")):this.$$("#loginAjax").showErrorDialog(this.t("user.loginError")+": "+o),window.appGlobals.sendLoginAndSignupToAnalytics(null,"Login Fail","Email",o)},_forgotPassword:function(){this.fire("yp-forgot-password")},_onRegisterChanged:function(i,o){if(this._setTexts(),this.$.dialog.fire("iron-resize"),1==i){var e=this.$$("#name");e&&e.focus()}},ready:function(){window.appGlobals&&window.appGlobals.domain&&this.set("domain",window.appGlobals.domain)},setup:function(i,o){this.set("onLoginFunction",i),this._setTexts(),o&&this.set("domain",o)},_setTexts:function(){this.emailErrorMessage=this.t("inputError"),this.passwordErrorMessage=this.t("inputError"),1===this.registerMode?(this.header=this.t("user.registerHeader"),this.set("submitText",this.t("user.create"))):(this.header=this.t("user.header"),this.set("submitText",this.t("user.login")))},_computeCredentials:function(i,o,e){return JSON.stringify({name:i,email:o,identifier:o,username:o,password:e})},_validateAndSend:function(i){if(window.appGlobals.sendLoginAndSignupToAnalytics(null,this.registerMode?"Signup Submit":"Login Submit","Email"),!(this.$$("#form").validate()&&this.email&&this.password))return this.$$("#loginAjax").showErrorDialog(this.t("user.completeForm")),window.appGlobals.sendLoginAndSignupToAnalytics(null,this.registerMode?"Signup Fail":"Login Fail","Email","Form not validated"),!1;this.registerMode?(this.$$("#registerAjax").body=this.credentials,this.$$("#registerAjax").generateRequest()):(this.$$("#loginAjax").body=this.credentials,this.$$("#loginAjax").generateRequest())},_registerResponse:function(i,o){window.appGlobals.sendLoginAndSignupToAnalytics(o.response.id,"Signup Success","Email"),this._loginCompleted(o.response)},_loginResponse:function(i,o){this._loginCompleted(o.response)},_loginCompleted:function(i){this.redirectToURL&&this.redirectTo(this.redirectToURL),this.fire("login",i),this.onLoginFunction?this.onLoginFunction(i):window.appUser.setLoggedInUser(i),document.dispatchEvent(new CustomEvent("lite-signal",{bubbles:!0,compose:!0,detail:{name:"logged-in",data:i}}))},open:function(i,o){this.redirectToURL=i,this.set("userSpinner",!1),this.set("opened",!1),o&&this.set("email",o),this.async(function(){this.set("opened",!0),this.async(function(){this.$$("#dialog").open()})}),window.appGlobals.sendLoginAndSignupToAnalytics(null,"Signup/Login Opened","Undecided")},close:function(){var i=this.$$("#dialog");i&&i.close(),this.set("opened",!1),this.set("userSpinner",!1)}});</script>